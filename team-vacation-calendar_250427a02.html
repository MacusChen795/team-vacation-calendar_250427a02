<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>團隊假期月曆</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee; --secondary: #3a0ca3; --success: #4cc9f0; --info: #4895ef;
      --warning: #f72585; --danger: #e63946; --light: #f8f9fa; --dark: #212529;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa; color: #333; font-size: 0.85rem; /* Slightly increased font size */
    }
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white; padding: 15px 0; border-radius: 0 0 25px 25px; /* Slightly larger border-radius */
      margin-bottom: 20px; /* Increased margin */
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); /* Stronger shadow */
    }
    .header h1 { font-size: 1.8rem; margin: 0; } /* Slightly larger heading */
    .header p { font-size: 0.9rem; margin: 0; opacity: 0.9; } /* Slightly larger text, lower opacity */
    .calendar-container {
      background-color: white; border-radius: 15px; padding: 15px; /* Increased padding */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Slightly stronger shadow */
    }
    .team-member {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 8px; /* Increased margin */
      padding: 6px 10px; /* Increased padding */
      border-radius: 50px;
      background: white; border: 1px solid #e9ecef; /* Added border */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
      transition: all 0.2s ease-in-out; /* Smoother transition */
    }
    .team-member:hover {
      background-color: #eef2f7; /* Subtle hover effect */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }
    .member-info-container { display: flex; align-items: center; flex-grow: 1; overflow: hidden; /* Prevent overflow */ }
    .avatar {
      width: 32px; height: 32px; /* Slightly larger avatar */
      border-radius: 50%; margin-right: 8px; /* Increased margin */
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: bold; font-size: 0.8rem; /* Slightly larger font */
      flex-shrink: 0; /* Prevent avatar from shrinking */
    }
    .member-info { font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } /* Improved info text handling */
    .member-actions {
      display: flex; gap: 6px; /* Increased gap */
      flex-shrink: 0; /* Prevent actions from shrinking */
    }
    .action-btn {
      color: #6c757d; cursor: pointer; font-size: 0.8rem; /* Slightly larger icon */
      padding: 3px; border-radius: 50%; transition: all 0.2s ease;
      display: flex; align-items: center; justify-content: center;
      width: 24px; height: 24px; /* Fixed size for buttons */
    }
    .edit-btn:hover { background-color: var(--primary); color: white; }
    .delete-btn:hover { background-color: var(--danger); color: white; }

    /* FullCalendar Customizations */
    .fc .fc-button-primary {
        background-color: var(--primary);
        border-color: var(--primary);
    }
    .fc .fc-button-primary:hover {
        background-color: var(--secondary);
        border-color: var(--secondary);
    }
    .fc .fc-button-primary:focus {
        box-shadow: 0 0 0 0.25rem rgba(var(--primary-rgb), .25);
    }
    .fc-event { border-radius: 4px; font-size: 0.75em; padding: 1px 4px; border: none; } /* Improved event styling */
    .fc-daygrid-event { margin-bottom: 1px; } /* Spacing between events */
    .fc-event-title { font-weight: 500; } /* Medium font weight for titles */
    .country-holiday-event .fc-event-title { font-weight: bold; } /* Bold for holidays */

    .country-holiday-details { /* Style for country holiday info in modal */
      border-left: 3px solid; padding-left: 8px;
      margin-top: 10px; padding-top: 5px; border-top: 1px solid #eee;
      font-size: 0.85em; color: #555;
    }
    .country-holiday-details.taiwan { border-color: #00A6A6; }
    .country-holiday-details.china { border-color: #FF4C4C; }
    .country-holiday-details.usa { border-color: #3C91E6; }

    .modal-content { border-radius: 12px; }
    .modal-header { border-bottom: none; padding-bottom: 0; }
    .modal-footer { border-top: none; padding-top: 0; }

    .btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; } /* Slightly larger button size */
    .form-label { font-size: 0.85rem; margin-bottom: 0.3rem; font-weight: 500;} /* Improved label styling */
    .form-control, .form-select { font-size: 0.85rem; padding: 0.4rem 0.6rem; } /* Improved input styling */
    .card { border-radius: 12px; overflow: hidden; } /* Card styling */
    .card-header { padding: 0.5rem 0.9rem; background-color: var(--primary); color: white; } /* Card header styling */
    .card-header.bg-primary { background-color: var(--primary)!important; }
    .card-header.bg-info { background-color: var(--info)!important; }
    .card-header.bg-success { background-color: var(--success)!important; }
    .card-header h5 { font-size: 1rem; margin-bottom: 0; }
    .card-body { padding: 0.8rem; } /* Increased card body padding */
    .card-footer { padding: 0.6rem 0.8rem; background-color: #f8f9fa; border-top: 1px solid #e9ecef; } /* Card footer styling */

    .legend-item {
      display: flex; align-items: center; margin-bottom: 6px; font-size: 0.8rem;
    }
    .legend-color {
      width: 14px; height: 14px; border-radius: 3px; margin-right: 6px;
      flex-shrink: 0; /* Prevent color block from shrinking */
    }
    #teamMembersList { max-height: 300px; overflow-y: auto; padding-right: 8px; /* Add padding for scrollbar */ } /* Increased max height */
    #teamMembersList::-webkit-scrollbar { width: 8px; }
    #teamMembersList::-webkit-scrollbar-track { background: #f8f9fa; border-radius: 4px; }
    #teamMembersList::-webkit-scrollbar-thumb { background: #ced4da; border-radius: 4px; }
    #teamMembersList::-webkit-scrollbar-thumb:hover { background: #adb5bd; }

    .leave-type {
      display: inline-block; padding: 2px 6px; border-radius: 4px; /* Increased padding/radius */
      font-size: 0.7rem; font-weight: bold; margin-right: 6px; /* Increased margin */
      margin-bottom: 4px; /* Add margin bottom for wrap */
    }
    .leave-type-annual { background-color: var(--success); color: white; }
    .leave-type-personal { background-color: var(--warning); color: white; }
    .leave-type-sick { background-color: var(--secondary); color: white; }
    .leave-type-other { background-color: #fb8500; color: white; } /* Custom color for other */

    /* Save Notification */
    .save-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1050; /* Above modals */
      background-color: rgba(0, 123, 255, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .save-notification.show {
      opacity: 1;
    }
    .manual-save-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1040; /* Below notification */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
     /* Adjust container padding for fixed buttons */
    .container { padding-bottom: 80px; }

  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1 class="text-center mb-1">團隊假期月曆</h1>
      <p class="text-center">管理團隊休假與查看各國假期</p>
    </div>
  </div>

  <div class="container mb-4">
    <div class="row">
      <div class="col-md-9">
        <div class="calendar-container">
          <div id="calendar"></div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">團隊成員</h5>
          </div>
          <div class="card-body" id="teamMembersList">
            <!-- Team members will be rendered here -->
          </div>
          <div class="card-footer text-center">
            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#memberModal" id="addMemberBtn">
              <i class="fas fa-user-plus"></i> 新增成員
            </button>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">假期圖例</h5>
          </div>
          <div class="card-body">
            <div class="legend-item">
              <div class="legend-color" style="background-color: #00A6A6;"></div>
              <span>台灣假期</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #FF4C4C;"></div>
              <span>中國假期</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #3C91E6;"></div>
              <span>美國假期</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: var(--primary);"></div>
              <span>團隊成員休假</span>
            </div>
            <div class="mt-3 pt-2 border-top border-light">
              <div class="mb-1 fw-bold small text-muted">休假類型:</div>
              <span class="leave-type leave-type-annual">特休</span>
              <span class="leave-type leave-type-personal">事假</span>
              <span class="leave-type leave-type-sick">病假</span>
              <span class="leave-type leave-type-other">其他</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">新增休假</h5>
          </div>
          <div class="card-body text-center">
            <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#addVacationModal">
              <i class="fas fa-calendar-plus"></i> 新增休假日期
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Member Modal -->
  <div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="memberModalTitle">新增團隊成員</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="memberForm">
            <input type="hidden" id="memberId">
            <div class="mb-3">
              <label for="memberName" class="form-label">成員姓名</label>
              <input type="text" class="form-control" id="memberName" required>
            </div>
            <div class="mb-3">
              <label for="memberDepartment" class="form-label">部門</label>
              <input type="text" class="form-control" id="memberDepartment" required>
            </div>
            <div class="mb-3">
              <label for="memberColor" class="form-label">顏色標記</label>
              <input type="color" class="form-control form-control-color" id="memberColor" value="#4361ee" title="選擇代表顏色">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveMemberBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Vacation Modal -->
  <div class="modal fade" id="addVacationModal" tabindex="-1" aria-labelledby="addVacationModalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addVacationModalTitle">新增休假日期</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addVacationForm">
            <div class="mb-3">
              <label for="vacationMember" class="form-label">選擇成員</label>
              <select class="form-select" id="vacationMember" required>
                <option value="">選擇成員...</option>
                <!-- Options will be populated by JS -->
              </select>
            </div>
            <div class="mb-3">
              <label for="vacationType" class="form-label">請假類型</label>
              <select class="form-select" id="vacationType" required>
                <option value="">選擇請假類型...</option>
                <option value="annual">特休</option>
                <option value="personal">事假</option>
                <option value="sick">病假</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="vacationStart" class="form-label">開始日期</label>
              <input type="date" class="form-control" id="vacationStart" required>
            </div>
            <div class="mb-3">
              <label for="vacationEnd" class="form-label">結束日期</label>
              <input type="date" class="form-control" id="vacationEnd" required>
            </div>
            <div class="mb-3">
              <label for="vacationReason" class="form-label">休假原因 (選填)</label>
              <textarea class="form-control" id="vacationReason" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveVacationBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Event Modal -->
  <div class="modal fade" id="viewEventModal" tabindex="-1" aria-labelledby="eventTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventTitle">假期詳情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="eventDetails">
          <!-- Event details will be populated here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-danger" id="deleteEventBtn">刪除</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Notification -->
  <div id="saveNotification" class="save-notification">資料已自動保存</div>

  <!-- Manual Save Button -->
  <button class="btn btn-primary manual-save-btn" id="manualSaveBtn">
    <i class="fas fa-save"></i> 儲存
  </button>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
  <!-- FontAwesome is already included via CDN link in head -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- Data Storage & Initialization ---
      let teamMembers = [];
      let vacations = [];

      const leaveTypes = {
        annual: { name: '特休', class: 'leave-type-annual' },
        personal: { name: '事假', class: 'leave-type-personal' },
        sick: { name: '病假', class: 'leave-type-sick' },
        other: { name: '其他', class: 'leave-type-other' }
      };

      // Sample hardcoded holidays (should ideally come from an API)
      const holidays = [
        // Taiwan Holidays (Adjust dates as needed for 2025+)
        { id: 'tw-qingming-2025', title: '清明節', start: '2025-04-04', country: 'taiwan' }, // Note: Clearness Festival can be 4th or 5th
        { id: 'tw-laborday-2025', title: '勞動節', start: '2025-05-01', country: 'taiwan' },
        { id: 'tw-dragonboat-2025', title: '端午節', start: '2025-05-31', country: 'taiwan' }, // Sample date
        { id: 'tw-midautumn-2025', title: '中秋節', start: '2025-10-06', country: 'taiwan' }, // Sample date
        { id: 'tw-nationalday-2025', title: '國慶日', start: '2025-10-10', country: 'taiwan' },
        { id: 'tw-newyear-2026', title: '中華民國開國紀念日', start: '2026-01-01', country: 'taiwan' },
        // China Holidays (Adjust dates as needed for 2025+)
        { id: 'cn-laborday-2025', title: '勞動節', start: '2025-05-01', end: '2025-05-06', country: 'china' }, // Often a multi-day holiday
        { id: 'cn-dragonboat-2025', title: '端午節', start: '2025-05-31', country: 'china' }, // Sample date
        { id: 'cn-nationalday-2025', title: '國慶節', start: '2025-10-01', end: '2025-10-08', country: 'china' }, // Often a multi-day holiday
        // USA Holidays (Adjust dates as needed for 2025+)
        { id: 'us-memorial-2025', title: 'Memorial Day', start: '2025-05-26', country: 'usa' }, // Last Monday in May
        { id: 'us-july4th-2025', title: 'Independence Day', start: '2025-07-04', country: 'usa' },
        { id: 'us-labor-2025', title: 'Labor Day', start: '2025-09-01', country: 'usa' }, // First Monday in Sep
        { id: 'us-thanksgiving-2025', title: 'Thanksgiving Day', start: '2025-11-27', country: 'usa' }, // Fourth Thursday in Nov
        { id: 'us-christmas-2025', title: 'Christmas Day', start: '2025-12-25', country: 'usa' },
      ];

      const countryColors = {
        taiwan: '#00A6A6', // Teal
        china: '#FF4C4C', // Red
        usa: '#3C91E6'    // Blue
      };

      const localStorageMembersKey = 'teamCalendarMembers';
      const localStorageVacationsKey = 'teamCalendarVacations';
      let autoSaveTimer;
      const autoSaveDelay = 3000; // 3 seconds delay

      // --- DOM Elements ---
      const calendarEl = document.getElementById('calendar');
      const teamMembersListEl = document.getElementById('teamMembersList');
      const memberModalEl = document.getElementById('memberModal');
      const memberModalTitleEl = document.getElementById('memberModalTitle');
      const memberFormEl = document.getElementById('memberForm');
      const memberIdInput = document.getElementById('memberId');
      const memberNameInput = document.getElementById('memberName');
      const memberDepartmentInput = document.getElementById('memberDepartment');
      const memberColorInput = document.getElementById('memberColor');
      const saveMemberBtn = document.getElementById('saveMemberBtn');

      const addVacationModalEl = document.getElementById('addVacationModal');
      const addVacationFormEl = document.getElementById('addVacationForm');
      const vacationMemberSelect = document.getElementById('vacationMember');
      const vacationTypeSelect = document.getElementById('vacationType');
      const vacationStartInput = document.getElementById('vacationStart');
      const vacationEndInput = document.getElementById('vacationEnd');
      const vacationReasonInput = document.getElementById('vacationReason');
      const saveVacationBtn = document.getElementById('saveVacationBtn');

      const viewEventModalEl = document.getElementById('viewEventModal');
      const eventTitleEl = document.getElementById('eventTitle');
      const eventDetailsEl = document.getElementById('eventDetails');
      const deleteEventBtn = document.getElementById('deleteEventBtn');

      const saveNotificationEl = document.getElementById('saveNotification');
      const manualSaveBtn = document.getElementById('manualSaveBtn');


      // --- Calendar Initialization ---
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listMonth'
        },
        locale: 'zh-tw',
        buttonText: {
          today: '今天',
          month: '月',
          week: '週',
          list: '列表'
        },
        events: [], // Events will be added dynamically
        eventClick: function(info) {
          showEventDetails(info.event);
        },
        eventTimeFormat: { // Ensure consistency, although holidays are all-day
          hour: '2-digit',
          minute: '2-digit',
          meridiem: false
        },
        navLinks: true, // Click day/week names to navigate views
        editable: false, // Disable drag/drop for simplicity
        dayMaxEvents: true, // Allow "more" link when too many events
        height: 'auto' // Adjust height to content
      });

      calendar.render();

      // --- Helper Functions ---
      function generateUniqueId() {
        return Date.now() + Math.random().toString(36).substr(2, 9);
      }

      function formatDate(date) {
        if (!date) return '';
        // Ensure date is treated as local time for display
        const d = new Date(date);
        // If the input date string doesn't specify time/timezone, Date object might interpret it as UTC.
        // To get local date components reliably for display:
        return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日 (${getWeekdayName(d.getDay())})`;
      }

       function getWeekdayName(dayIndex) {
           const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
           return weekdays[dayIndex];
       }

      function getCountryName(countryCode) {
        const countries = {
          taiwan: '台灣',
          china: '中國',
          usa: '美國'
        };
        return countries[countryCode] || countryCode;
      }

      // --- Data Persistence (localStorage) ---
      function saveData() {
        try {
          localStorage.setItem(localStorageMembersKey, JSON.stringify(teamMembers));
          localStorage.setItem(localStorageVacationsKey, JSON.stringify(vacations));
          console.log('Data saved to localStorage.');
          showSaveNotification();
        } catch (e) {
          console.error('Error saving data to localStorage:', e);
          // Optionally show an error notification to the user
        }
      }

      function loadSavedData() {
        try {
          const savedMembers = localStorage.getItem(localStorageMembersKey);
          const savedVacations = localStorage.getItem(localStorageVacationsKey);

          if (savedMembers) {
            teamMembers = JSON.parse(savedMembers);
            console.log('Team members loaded from localStorage.');
          } else {
             // Load initial sample data if localStorage is empty
             teamMembers = [
                { id: generateUniqueId(), name: '王小明', department: '行銷部', color: '#4361ee' },
                { id: generateUniqueId(), name: '李小花', department: '設計部', color: '#f72585' },
                { id: generateUniqueId(), name: '張大山', department: '工程部', color: '#4cc9f0' },
                { id: generateUniqueId(), name: '陳小雨', department: '人資部', color: '#560bad' },
                { id: generateUniqueId(), name: '林小樹', department: '財務部', color: '#fb8500' }
             ];
             console.log('Loaded initial sample team members.');
          }

          if (savedVacations) {
            vacations = JSON.parse(savedVacations);
            console.log('Vacations loaded from localStorage.');
          } else {
              // Load initial sample data if localStorage is empty
              vacations = [
                // Link sample vacations to loaded/sample members if they exist
                ...(teamMembers[0] ? [{ id: generateUniqueId(), memberId: teamMembers[0].id, start: '2025-04-15', end: '2025-04-20', reason: '家庭旅遊', type: 'annual' }] : []),
                ...(teamMembers[1] ? [{ id: generateUniqueId(), memberId: teamMembers[1].id, start: '2025-04-22', end: '2025-04-23', reason: '感冒休息', type: 'sick' }] : []),
                ...(teamMembers[2] ? [{ id: generateUniqueId(), memberId: teamMembers[2].id, start: '2025-05-01', end: '2025-05-03', reason: '個人事務', type: 'personal' }] : [])
             ];
             console.log('Loaded initial sample vacations.');
          }

        } catch (e) {
          console.error('Error loading data from localStorage:', e);
          // If loading fails, initialize with empty arrays to prevent script errors
          teamMembers = [];
          vacations = [];
          alert('無法載入已儲存的資料。將使用預設或空白資料。');
        }
      }

      function autoSave() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveData, autoSaveDelay);
      }

      function showSaveNotification() {
        saveNotificationEl.classList.add('show');
        setTimeout(() => {
          saveNotificationEl.classList.remove('show');
        }, 3000); // Hide after 3 seconds
      }


      // --- Rendering Functions ---
      function renderTeamMembers() {
        teamMembersListEl.innerHTML = '';

        if (teamMembers.length === 0) {
            teamMembersListEl.innerHTML = '<p class="text-center text-muted small py-2 mb-0">尚無團隊成員。<br>請點擊下方按鈕新增。</p>';
            return;
        }

        teamMembers.forEach(member => {
          const memberEl = document.createElement('div');
          memberEl.className = 'team-member';
          memberEl.dataset.memberId = member.id; // Add data attribute for delegation

          memberEl.innerHTML = `
            <div class="member-info-container">
              <div class="avatar" style="background-color: ${member.color};">${member.name.charAt(0)}</div>
              <div class="member-info">
                <div class="fw-bold">${member.name}</div>
                <div class="text-muted small">${member.department}</div>
              </div>
            </div>
            <div class="member-actions">
              <div class="action-btn edit-btn"><i class="fas fa-edit"></i></div>
              <div class="action-btn delete-btn"><i class="fas fa-trash-alt"></i></div>
            </div>
          `;
          teamMembersListEl.appendChild(memberEl);
        });

        updateVacationMemberSelect();
      }

      function updateVacationMemberSelect() {
        vacationMemberSelect.innerHTML = '<option value="">選擇成員...</option>';

        teamMembers.forEach(member => {
          const option = document.createElement('option');
          option.value = member.id;
          option.textContent = `${member.name} (${member.department})`;
          vacationMemberSelect.appendChild(option);
        });
      }

      function loadCalendarEvents() {
        // Clear existing custom events (keep holidays if desired, or reload them too)
        calendar.getEvents().filter(e => e.extendedProps.type !== 'holiday').forEach(e => e.remove());

        // Add vacations
        vacations.forEach(vacation => {
          const member = teamMembers.find(m => m.id === vacation.memberId);
          if (member) {
             // FullCalendar end date is exclusive for all-day events. Add 1 day for correct rendering.
             const endDate = new Date(vacation.end);
             endDate.setDate(endDate.getDate() + 1);
             const endDateString = endDate.toISOString().split('T')[0];

            calendar.addEvent({
              id: vacation.id,
              title: `${member.name} - ${leaveTypes[vacation.type]?.name || '未指定'}`,
              start: vacation.start,
              end: endDateString, // Exclusive end date for FC
              color: member.color,
              allDay: true,
              extendedProps: {
                reason: vacation.reason,
                type: 'vacation',
                leaveType: vacation.type,
                member: member.name, // Store member info directly for display
                department: member.department
              }
            });
          }
        });

        // Add holidays (only once on load)
        if (calendar.getEvents().filter(e => e.extendedProps.type === 'holiday').length === 0) {
           holidays.forEach(holiday => {
             // FullCalendar end date is exclusive for all-day events. Add 1 day if end date exists.
             let holidayEndDate = holiday.end;
             if (holidayEndDate) {
                 const endDate = new Date(holidayEndDate);
                 endDate.setDate(endDate.getDate() + 1);
                 holidayEndDate = endDate.toISOString().split('T')[0];
             }

             calendar.addEvent({
               id: holiday.id,
               title: `[${getCountryName(holiday.country)}] ${holiday.title}`,
               start: holiday.start,
               end: holidayEndDate, // Exclusive end date for FC if multi-day
               color: countryColors[holiday.country],
               allDay: true,
               display: 'background', // Holidays as background events
               extendedProps: {
                 type: 'holiday',
                 country: holiday.country
               },
               classNames: ['country-holiday-event'] // Add class for styling
             });
           });
        }
      }


      // --- Member Management ---
      function openAddMemberModal() {
        memberModalTitleEl.textContent = '新增團隊成員';
        memberIdInput.value = '';
        memberFormEl.reset();
        memberColorInput.value = '#4361ee'; // Default color
      }

      function openEditMemberModal(memberId) {
        const member = teamMembers.find(m => m.id === memberId);
        if (member) {
          memberModalTitleEl.textContent = '編輯團隊成員';
          memberIdInput.value = member.id;
          memberNameInput.value = member.name;
          memberDepartmentInput.value = member.department;
          memberColorInput.value = member.color;
          const modal = new bootstrap.Modal(memberModalEl);
          modal.show();
        }
      }

      function saveMember() {
        const id = memberIdInput.value;
        const name = memberNameInput.value.trim();
        const department = memberDepartmentInput.value.trim();
        const color = memberColorInput.value;

        if (!name || !department) {
          // Basic validation feedback (could enhance with Bootstrap validation classes)
          alert('請填寫成員姓名和部門。');
          return;
        }

        if (id) {
          // Edit existing member
          const index = teamMembers.findIndex(m => m.id === id);
          if (index !== -1) {
            teamMembers[index] = { id: id, name, department, color };

            // Update associated vacations in data and calendar
            vacations.filter(v => v.memberId === id).forEach(vacation => {
                const typeInfo = leaveTypes[vacation.type];
                vacation.title = `${name} - ${typeInfo?.name || '未指定'}`;

                const event = calendar.getEventById(vacation.id);
                if (event) {
                    event.setProp('title', vacation.title);
                    event.setProp('color', color);
                    event.setExtendedProp('member', name);
                    event.setExtendedProp('department', department);
                }
            });

            renderTeamMembers();
            // No need to reload all events, direct update on calendar events is done above
            autoSave();
          }
        } else {
          // Add new member
          const newMember = {
            id: generateUniqueId(), // Generate unique ID
            name,
            department,
            color
          };
          teamMembers.push(newMember);
          renderTeamMembers(); // Re-render the list
          updateVacationMemberSelect(); // Update the select dropdown
          autoSave();
        }

        bootstrap.Modal.getInstance(memberModalEl).hide();
      }

      function deleteMember(memberId) {
        if (confirm('確定要刪除此成員及其所有相關休假記錄嗎？')) {
          // Remove vacations associated with this member
          vacations = vacations.filter(v => v.memberId !== memberId);

          // Remove member
          teamMembers = teamMembers.filter(m => m.id !== memberId);

          // Update UI and Calendar
          renderTeamMembers();
          loadCalendarEvents(); // Easiest way to update calendar after mass deletion
          autoSave();
        }
      }


      // --- Vacation Management ---
      function saveVacation() {
        const memberId = vacationMemberSelect.value;
        const leaveType = vacationTypeSelect.value;
        const start = vacationStartInput.value;
        let end = vacationEndInput.value;
        const reason = vacationReasonInput.value.trim();

        if (!memberId || !leaveType || !start || !end) {
           alert('請填寫所有必填的休假資訊 (成員、類型、開始/結束日期)。');
           return;
        }

        // Ensure end date is not before start date
        if (new Date(start) > new Date(end)) {
            alert('結束日期不能早於開始日期。');
            return;
        }

        const member = teamMembers.find(m => m.id === memberId);
        if (!member) {
            alert('選擇的成員不存在。請重新整理頁面。'); // Should not happen if select is updated correctly
            return;
        }

        const newVacation = {
          id: generateUniqueId(), // Generate unique ID
          memberId,
          start,
          end, // Store original end date
          reason,
          type: leaveType
        };

        vacations.push(newVacation);

        // Add to FullCalendar (adjusting end date)
        const endDateForFC = new Date(end);
        endDateForFC.setDate(endDateForFC.getDate() + 1);
        const endDateStringForFC = endDateForFC.toISOString().split('T')[0];

        calendar.addEvent({
            id: newVacation.id,
            title: `${member.name} - ${leaveTypes[leaveType]?.name || '未指定'}`,
            start: newVacation.start,
            end: endDateStringForFC, // Exclusive end date for FC
            color: member.color,
            allDay: true,
            extendedProps: {
              reason: newVacation.reason,
              type: 'vacation',
              leaveType: newVacation.type,
              member: member.name, // Store for display
              department: member.department // Store for display
            }
        });

        bootstrap.Modal.getInstance(addVacationModalEl).hide();
        addVacationFormEl.reset(); // Clear the form
        autoSave();
      }

      function deleteVacation(vacationId) {
         if (confirm('確定要刪除這筆休假記錄嗎？')) {
            vacations = vacations.filter(v => v.id !== vacationId);

            // Remove from FullCalendar
            const event = calendar.getEventById(vacationId);
            if (event) {
              event.remove();
            }

            bootstrap.Modal.getInstance(viewEventModalEl).hide();
            autoSave();
         }
      }


      // --- Event Details Modal ---
      function showEventDetails(event) {
        const props = event.extendedProps;
        eventTitleEl.textContent = event.title;
        deleteEventBtn.style.display = 'none'; // Hide delete by default

        if (props.type === 'vacation') {
          const typeInfo = leaveTypes[props.leaveType] || { name: '未指定', class: '' };
          const vacationData = vacations.find(v => v.id === event.id); // Find original data for correct end date display

          eventDetailsEl.innerHTML = `
            <div class="mb-2">
              <strong>成員:</strong> ${props.member || 'N/A'}
            </div>
            <div class="mb-2">
              <strong>部門:</strong> ${props.department || 'N/A'}
            </div>
            <div class="mb-2">
              <strong>請假類型:</strong> <span class="leave-type ${typeInfo.class}">${typeInfo.name}</span>
            </div>
            <div class="mb-2">
              <strong>開始日期:</strong> ${formatDate(event.start)}
            </div>
            <div class="mb-2">
              <strong>結束日期:</strong> ${vacationData ? formatDate(vacationData.end) : formatDate(event.start)}
            </div>
            <div class="mb-2">
              <strong>原因:</strong> ${props.reason || '(未提供)'}
            </div>
          `;

          deleteEventBtn.style.display = 'block';
          deleteEventBtn.dataset.eventId = event.id; // Store event ID for deletion
        } else if (props.type === 'holiday') {
           // For holidays, the event.end from FC is already the day *after* the last day if it's multi-day.
           // Need to get the actual end date for display.
           // The original 'holidays' array has the correct inclusive end date.
           const holidayData = holidays.find(h => h.id === event.id);
           const displayEndDate = holidayData ? holidayData.end : event.start;


          eventDetailsEl.innerHTML = `
            <div class="mb-2">
              <strong>國家:</strong> ${getCountryName(props.country)}
            </div>
            <div class="mb-2">
              <strong>開始日期:</strong> ${formatDate(event.start)}
            </div>
            <div class="mb-2">
              <strong>結束日期:</strong> ${formatDate(displayEndDate)}
            </div>
            <div class="country-holiday-details ${props.country}">
              這是 ${getCountryName(props.country)} 的法定假期。
            </div>
          `;
          // No delete button for hardcoded holidays
        }

        const modalInstance = new bootstrap.Modal(viewEventModalEl);
        modalInstance.show();
      }


      // --- Event Listeners ---
      // Member modal show/hide listeners to manage form state
      memberModalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; // Button that triggered the modal
        if (button.id === 'addMemberBtn') {
          openAddMemberModal();
        } // Edit is handled via delegated click listener
      });

      memberModalEl.addEventListener('hidden.bs.modal', function () {
         memberFormEl.reset(); // Reset form on hide regardless of how it was opened
         memberIdInput.value = ''; // Clear ID
         memberModalTitleEl.textContent = '新增團隊成員'; // Reset title
         memberColorInput.value = '#4361ee'; // Reset color to default
      });


      // Delegated event listeners for member list actions (edit/delete)
      teamMembersListEl.addEventListener('click', function(event) {
          const target = event.target;
          const memberEl = target.closest('.team-member');

          if (!memberEl) return; // Click wasn't inside a member element

          const memberId = memberEl.dataset.memberId;

          if (target.closest('.edit-btn')) {
              openEditMemberModal(memberId);
          } else if (target.closest('.delete-btn')) {
              deleteMember(memberId);
          }
      });


      // Save member button click
      saveMemberBtn.addEventListener('click', saveMember);

      // Save vacation button click
      saveVacationBtn.addEventListener('click', saveVacation);

      // Delete event button click (from view event modal)
      deleteEventBtn.addEventListener('click', function() {
          const eventId = this.dataset.eventId; // Get ID from the button's data attribute
          if (eventId) {
             // Check if it's a vacation event
             const event = calendar.getEventById(eventId);
             if (event && event.extendedProps.type === 'vacation') {
                 deleteVacation(eventId);
             }
          }
      });

      // Manual save button
      manualSaveBtn.addEventListener('click', saveData);


      // --- Initialization ---
      loadSavedData(); // Load data first
      renderTeamMembers(); // Render members list based on loaded data
      loadCalendarEvents(); // Load vacations and holidays into calendar


      // Optional: Default end date to start date when selecting start date in vacation form
      vacationStartInput.addEventListener('change', function() {
          if (!vacationEndInput.value) {
              vacationEndInput.value = vacationStartInput.value;
          }
      });

      // Optional: Ensure end date is at least start date
      vacationEndInput.addEventListener('change', function() {
          if (vacationStartInput.value && new Date(vacationStartInput.value) > new Date(vacationEndInput.value)) {
              vacationEndInput.value = vacationStartInput.value;
          }
      });

    });
  </script>
</body>
</html>